#!/bin/sh
#
# ZFT Lab. 2018 | http://zftlab.org/pages/2018010700.html
# Simple Plugin - WiFi


IPC=/mnt/mtd/ipcam.conf
CFG=/var/tmp/wpa_supplicant.conf
TMP=/var/tmp


if [ -f ${IPC} ]; then
  #
  while read settings
    do local ${settings}
  done < ${IPC}
  #
  if [ ${wifi_enable} = 1 ]; then
    #
    local wifi_iface=auto  # Wait ra0/eth2
    #
    # USB WiFi MT7601
    if grep "ProdID=7601" /proc/bus/usb/devices > /dev/null; then
      if [ -e /mnt/web/zftlab/lib/modules/mt7601Usta.ko ]; then
        himm 0x20050084 0x001d2188
        himm 0x20050078 0x1414c001
        insmod /mnt/web/zftlab/lib/modules/mt7601Usta.ko
        local wifi_type=mt7601
        local wifi_iface=ra0
      fi
    fi
    #
    # USB WiFi RT3070
    if grep "ProdID=3070" /proc/bus/usb/devices > /dev/null; then
      if [ -e /mnt/web/zftlab/lib/modules/rt3070sta.ko ]; then
        himm 0x20050084 0x001d2188
        himm 0x20050078 0x1414c001
        insmod /mnt/web/zftlab/lib/modules/rt3070sta.ko
        local wifi_type=rt3070
        local wifi_iface=eth2
      fi
    fi
    #
    # USB WiFi RTL8188
    if grep "ProdID=8179" /proc/bus/usb/devices > /dev/null; then
      if [ -e /mnt/web/zftlab/lib/modules/8188eu.ko ]; then
        himm 0x20050084 0x001d2188
        himm 0x20050078 0x1414c001
        insmod /mnt/web/zftlab/lib/modules/8188eu.ko
        local wifi_type=rtl8188
        local wifi_iface=eth2
      fi
    fi
    #
    # USB WiFi RTL8187
    #if grep "ProdID=8187" /proc/bus/usb/devices > /dev/null; then
    #  if [ -e /mnt/web/zftlab/lib/modules/8188eu.ko ]; then
    #    himm 0x20050084 0x001d2188
    #    himm 0x20050078 0x1414c001
    #    insmod /mnt/web/zftlab/lib/modules/8188eu.ko
    #    local wifi_type=rtl8187
    #    local wifi_iface=eth2
    #  fi
    #fi
    #
    if [ ${wifi_iface} != "auto" ]; then
      #
      local wifi_psk=$(wpa_passphrase ${wifi_ssid} ${wifi_password} | awk -F '=' '/psk/ {print $2}' | tail -n 1)
      #
      ip link set ${wifi_iface} down
      ip link set ${wifi_iface} name wlan0
      local wifi_iface=wlan0
      ip link set ${wifi_iface} up
      #
      ( echo "#"
        echo "# ZFT Lab. 2018 | http://zftlab.org/pages/2018010700.html"
        echo "# Simple example VTUNd config (autogenerated)"
        echo "#"
        echo "ctrl_interface_group=0"
        echo "ap_scan=1"
        echo "#"
        echo "network={"
        echo "  ssid=\"${wifi_ssid}\""
        echo "  #psk=\"${wifi_password}\""
        echo "  psk=${wifi_psk}"
        echo "  proto=WPA2"
        echo "  key_mgmt=WPA-PSK"
        echo "  pairwise=CCMP TKIP"
        echo "  group=CCMP TKIP"
        echo "}"
      ) >${CFG}
      #
      ifconfig ${wifi_iface} up
      #
      if [ -f /bin/wpa_supplicant ]; then
        (while true ; do sleep 1; wpa_supplicant -P ${TMP}/wpa_supplicant-${wifi_iface}.pid -D wext -i ${wifi_iface} -c ${CFG} -C ${TMP}/wpa_supplicant >/dev/null 2>&1; done) &
        sleep 5; iwpriv ${wifi_iface} set WPAPSK=${wifi_psk}
      fi
      #
      # (while true ; do sleep 5; udhcpc -f -C -p ${TMP}/udhcpc-${wifi_iface}.pid -s /bin/tapip -t 0 -i ${wifi_iface} -C >/dev/null 2>&1; done) &
      (while true ; do sleep 5; udhcpc -f -C -p ${TMP}/udhcpc-${wifi_iface}.pid -s /usr/sbin/udhcpc.script.wifi -t 0 -i ${wifi_iface} -x hostname:${device_name} >/dev/null 2>&1; done) &
      #
    fi
    #
  fi
  #
fi

exit 0
