#!/bin/sh
#
# ZFT Lab. 2018 | http://zftlab.org/pages/2018010700.html
# Simple Plugin - Tunnel


MAC=$(ifconfig eth0 | awk '/HWaddr/ {print $5}')
PAS=$(echo ${MAC} | sha1sum | awk '{print $1}')
TID=$(echo ${MAC} | tr -d ':')
IPC=/mnt/mtd/ipcam.conf
CFG=/var/tmp/vtund.conf
TMP=/var/tmp


if [ -f ${IPC} ]; then
  #
  while read settings
    do local ${settings}
  done < ${IPC}
  #
  if [ ${vtund_enable} = 1 ]; then
    #
    [ -f /mnt/web/zftlab/lib/modules/tun.ko ] && insmod /mnt/web/zftlab/lib/modules/tun.ko >/dev/null 2>&1
    #
    ( echo "#"
      echo "# ZFT Lab. 2018 | http://zftlab.org/pages/2018010700.html"
      echo "# Simple example VTUNd config (autogenerated)"
      echo "#"
      echo "options {"
      echo "  port ${vtund_port};"
      echo "  ifconfig /sbin/ifconfig;"
      echo "}"
      echo "${TID} {"
      echo "  password ${PAS};"
      echo "  device tunnel;"
      echo "  stat no;"
      echo "  persist yes;"
      echo "  timeout 10;"
      echo "  up {"
      echo "    ifconfig \"%d hw ether ${MAC} mtu 1500 -multicast up\";"
      echo "    program \"udhcpc -q -n -C -p /var/tmp/udhcpc-%%.pid -s /bin/tapip -i %d -t 5 -x hostname:${device_name}\";"
      echo "  };"
      echo "  down {"
      echo "    ifconfig \"%d down\";"
      echo "  };"
      echo "}"
    ) >${CFG}
    #
    (while true ; do sleep 10; tunctl -t tunnel; vtund -n -f ${CFG} ${TID} ${vtund_server} >/dev/null 2>&1; done) &
  fi
fi

exit 0
